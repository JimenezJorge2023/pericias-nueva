<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta de Pericias</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
  </style>

  <script>
    const API_KEY = 'YOUR_API_KEY';
    const CLIENT_ID = '606755915794-gt1h98f6md7bpcn05h2nk4q59g1vkce.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1FWWZGmQWkaarAm0YJOKe7yI5kRB0YhiH';
    const SHEET_NAME = 'GENERAL';
    const RANGE = 'G:V';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

    let tokenClient, gapiInited = false, gisInited = false;
    let authSection, searchSection, authorizeButton, searchButton, searchInput, resultsTableBody, noResultsMessage, loadingIndicator;

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (!authSection || !searchSection || !authorizeButton || !searchButton || !searchInput || !resultsTableBody || !noResultsMessage || !loadingIndicator) {
        setTimeout(maybeEnableButtons, 100);
        return;
      }

      if (gapiInited && gisInited) {
        authorizeButton.onclick = handleAuthClick;
        searchButton.onclick = handleSearchClick;
        authSection.classList.remove('hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      authSection = document.getElementById('auth-section');
      searchSection = document.getElementById('search-section');
      authorizeButton = document.getElementById('authorize_button');
      searchButton = document.getElementById('searchButton');
      searchInput = document.getElementById('searchInput');
      resultsTableBody = document.getElementById('resultsTableBody');
      noResultsMessage = document.getElementById('noResultsMessage');
      loadingIndicator = document.getElementById('loadingIndicator');
      maybeEnableButtons();
    });

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error) {
          console.error('Error de autenticación:', resp);
          alert('Error al iniciar sesión.');
          return;
        }
        authSection.classList.add('hidden');
        searchSection.classList.remove('hidden');
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        authSection.classList.add('hidden');
        searchSection.classList.remove('hidden');
      }
    }

    async function handleSearchClick() {
      const searchTerm = searchInput.value.toLowerCase();
      if (!searchTerm) {
        alert('Por favor, ingresa un valor de búsqueda.');
        return;
      }

      resultsTableBody.innerHTML = '';
      noResultsMessage.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');

      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SHEET_NAME}!${RANGE}`,
        });

        const rows = response.result.values || [];
        const filteredResults = [];

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const colG = row[0] ? row[0].toLowerCase() : '';
          const colJ = row[3] ? row[3].toLowerCase() : '';

          if (colG.includes(searchTerm) || colJ.includes(searchTerm)) {
            filteredResults.push({
              periciasRelacionadas: row[2] || '',
              peritoAsignado: row[11] || '',
              estado: row[15] || '',
              sumilla: row[13] || '',
              documentoSalida: row[14] || '',
            });
          }
        }

        displayResults(filteredResults);
      } catch (err) {
        console.error(err);
        noResultsMessage.textContent = 'Error al cargar los datos.';
        noResultsMessage.classList.remove('hidden');
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    function displayResults(results) {
      if (results.length === 0) {
        noResultsMessage.classList.remove('hidden');
        return;
      }

      results.forEach(item => {
        const row = document.createElement('tr');
        row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
        row.innerHTML = `
          <td class="py-3 px-6">${item.periciasRelacionadas}</td>
          <td class="py-3 px-6">${item.peritoAsignado}</td>
          <td class="py-3 px-6">${item.estado}</td>
          <td class="py-3 px-6">${item.sumilla}</td>
          <td class="py-3 px-6">${item.documentoSalida}</td>
        `;
        resultsTableBody.appendChild(row);
      });
    }
  </script>
</head>

<body class="min-h-screen bg-gray-100 p-6 flex flex-col items-center">
  <div class="w-full max-w-5xl bg-white shadow-lg rounded-xl p-8 space-y-6">
    <h1 class="text-3xl font-bold text-center text-indigo-700">Consulta de Pericias</h1>

    <div id="auth-section" class="flex flex-col items-center space-y-4">
      <p class="text-gray-600 text-center">Inicia sesión con tu cuenta de Google para acceder a los datos.</p>
      <button id="authorize_button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold shadow-md transition transform hover:scale-105">
        Iniciar Sesión con Google
      </button>
    </div>

    <div id="search-section" class="hidden space-y-4">
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <input id="searchInput" type="text" placeholder="Buscar en columna G o J"
          class="flex-grow p-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center" />
        <button id="searchButton"
          class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold shadow-md transition transform hover:scale-105">
          Buscar
        </button>
      </div>

      <div id="loadingIndicator" class="hidden text-center text-indigo-600 font-medium">Cargando resultados...</div>

      <div class="overflow-x-auto mt-4">
        <table class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
          <thead class="bg-gray-200 text-gray-700 uppercase text-sm">
            <tr>
              <th class="py-3 px-6 text-left">Pericias Relacionadas</th>
              <th class="py-3 px-6 text-left">Perito Asignado</th>
              <th class="py-3 px-6 text-left">Estado</th>
              <th class="py-3 px-6 text-left">Sumilla</th>
              <th class="py-3 px-6 text-left">Documento Salida</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody" class="text-sm text-gray-700"></tbody>
        </table>
        <p id="noResultsMessage" class="hidden text-center text-gray-500 mt-4">No se encontraron resultados.</p>
      </div>
    </div>
  </div>
</body>
</html>
